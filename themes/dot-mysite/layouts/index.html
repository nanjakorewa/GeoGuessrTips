{{ define "main" }}
  {{ "<!-- topics -->" | safeHTML }}
  <section class="section" style="margin-bottom:0px;padding-bottom:0px;">
    <div class="container">
      {{ $docs := where .Site.Pages "Type" "docs" }}
      {{ $.Scratch.Set "ruleDocs" (slice) }}
      {{ $.Scratch.Set "otherDocs" (slice) }}
      {{ range $docs }}
        {{ if or (hasPrefix .RelPermalink "/rule/") (hasPrefix .RelPermalink "/id/rule/") (hasPrefix .RelPermalink "/en/rule/") (hasPrefix .RelPermalink "/es/rule/") }}
          {{ $.Scratch.Add "ruleDocs" (slice .) }}
        {{ else }}
          {{ $.Scratch.Add "otherDocs" (slice .) }}
        {{ end }}
      {{ end }}
      {{ $ruleDocs := $.Scratch.Get "ruleDocs" }}
      {{ $otherDocs := $.Scratch.Get "otherDocs" }}

      {{ if $ruleDocs }}
      <div class="row justify-content-center mb-4">
        <div class="col-12">
          <h2 class="section-title text-left" style="margin-bottom:1.5rem;">{{ i18n "homepage_rule_section_title" }}</h2>
        </div>
        {{ range $ruleDocs }}
        {{ $cardImage := default "" (default .Params.bg .Params.card_image) }}
        {{ $cardImagePath := "" }}
        {{ with $cardImage }}
          {{ if or (hasPrefix . "http://") (hasPrefix . "https://") }}
            {{ $cardImagePath = . }}
          {{ else }}
            {{ $normalized := strings.TrimPrefix "/" . }}
            {{ $cardRel := cond (hasPrefix $normalized "bg/") $normalized (printf "bg/%s" $normalized) }}
            {{ $cardImagePath = printf "/%s" (strings.TrimPrefix "/" $cardRel) }}
          {{ end }}
        {{ end }}
        {{ $cardClasses := "px-3 py-2 shadow d-block match-height apply-bg" }}
        {{ if $cardImagePath }}
          {{ $cardClasses = printf "%s card-with-image" $cardClasses }}
        {{ end }}
        <div class="col-lg-4 col-sm-6 mb-3">
          <a href="{{ .Permalink }}" class="{{ $cardClasses }}" {{ if $cardImagePath }}style="--card-bg-image: url('{{ $cardImagePath }}');"{{ end }}>
            <h3 class="mb-3 mt-0">{{ if eq .Params.weight 1 }}<i class="fas fa-map-marker-alt" style="margin-right:0.2em; color:rgb(188, 57, 57);"></i>{{ end }}{{ .Title }}</h3>
            <p class="mb-0">{{ .Params.Description }}</p>
          </a>
        </div>
        {{ end }}
      </div>
      {{ end }}

      <div class="row justify-content-center">
        {{ if $otherDocs }}
        <div class="col-12">
          <h2 class="section-title text-left" style="margin-bottom:1.5rem;">{{ i18n "homepage_other_section_title" }}</h2>
        </div>
        {{ range $otherDocs }}
        {{ $cardImage := default "" (default .Params.bg .Params.card_image) }}
        {{ $cardImagePath := "" }}
        {{ with $cardImage }}
          {{ if or (hasPrefix . "http://") (hasPrefix . "https://") }}
            {{ $cardImagePath = . }}
          {{ else }}
            {{ $normalized := strings.TrimPrefix "/" . }}
            {{ $cardRel := cond (hasPrefix $normalized "bg/") $normalized (printf "bg/%s" $normalized) }}
            {{ $cardImagePath = printf "/%s" (strings.TrimPrefix "/" $cardRel) }}
          {{ end }}
        {{ end }}
        {{ $cardClasses := "px-3 py-2 shadow d-block match-height apply-bg" }}
        {{ if $cardImagePath }}
          {{ $cardClasses = printf "%s card-with-image" $cardClasses }}
        {{ end }}
        <div class="col-lg-4 col-sm-6 mb-3">
          <a href="{{ .Permalink }}" class="{{ $cardClasses }}" {{ if $cardImagePath }}style="--card-bg-image: url('{{ $cardImagePath }}');"{{ end }}>
            <h3 class="mb-3 mt-0">{{ .Title }}</h3>
            <p class="mb-0">{{ .Params.Description }}</p>
          </a>
        </div>
        {{ end }}
        {{ end }}
        <div class="col-lg-4 col-sm-6 mb-3">
          <a href="https://nanjakorewa.booth.pm/" class="px-3 py-2 shadow d-block match-height apply-bg card-with-image" style="--card-bg-image: url('/bg/default.jpg');">
            <h3 class="mb-3 mt-0">BOOTH</h3>
            <p class="mb-0">{{ i18n "homepage_booth_caption" }}</p>
          </a>
        </div>
      </div>
    </div>
  </section>
  {{ "<!-- /topics -->" | safeHTML }}

    {{ "<!-- updates + milestone -->" | safeHTML }}
    {{ if eq .Page.Lang "ja" }}
      {{ $updates := .Site.Params.recent_update }}
      {{ $milestone := .Site.Params.milestone_access_message }}
      {{ if or $updates $milestone }}
      <section class="section section-updates pt-0 pb-5" aria-labelledby="updates-milestone-heading">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-xl-9 col-lg-10">
              <div class="update-milestone-card">
                {{ with $updates }}
                {{ $items := .items }}
                {{ if or .label (gt (len $items) 0) }}
                <div class="update-milestone-card__updates">
                  {{ if .label }}
                  <div class="update-milestone-card__label">{{ .label }}</div>
                  {{ end }}
                  {{ with $items }}
                  <ul class="update-milestone-card__list">
                    {{ range . }}
                      {{ if .title }}
                      <li class="update-milestone-card__item">
                        {{ if .link }}
                          <a href="{{ .link }}">{{ .title }}</a>
                        {{ else }}
                          <span>{{ .title }}</span>
                        {{ end }}
                        {{ if .date }}<span class="update-milestone-card__date">@{{ .date }}</span>{{ end }}
                      </li>
                      {{ end }}
                    {{ end }}
                  </ul>
                  {{ end }}
                </div>
                {{ end }}
                {{ end }}
                {{ if and $updates $milestone }}
                <div class="update-milestone-card__divider" aria-hidden="true"></div>
                {{ end }}
                {{ with $milestone }}
                <div class="update-milestone-card__milestone">
                  <div class="update-milestone-card__milestone-badge">Milestone</div>
                  <h3 class="update-milestone-card__title">{{ .title }}</h3>
                  <p class="update-milestone-card__text">{{ .description }}</p>
                </div>
                {{ end }}
              </div>
            </div>
          </div>
        </div>
      </section>
      {{ end }}
    {{ end }}
    {{ "<!-- /updates + milestone -->" | safeHTML }}
{{ end }}
