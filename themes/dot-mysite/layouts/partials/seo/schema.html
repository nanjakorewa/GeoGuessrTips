{{- $page := .Page -}}
{{- $seo := .SEO -}}
{{- $site := $page.Site -}}
{{- $siteParams := $site.Params -}}

{{- $socialScratch := newScratch -}}
{{- $socialScratch.Set "sameAs" (slice) -}}
{{- range $siteParams.social }}
  {{- with .link }}
    {{- $socialScratch.Add "sameAs" (slice .) -}}
  {{- end }}
{{- end }}
{{- $sameAs := $socialScratch.Get "sameAs" -}}

{{- $org := $siteParams.organization -}}
{{- $orgName := default $site.Title (index $org "name") -}}
{{- $orgUrl := default $site.BaseURL (index $org "url") -}}
{{- $orgLogo := index $org "logo" -}}
{{- $orgScratch := newScratch -}}
{{- $orgScratch.Set "data" (dict "@context" "https://schema.org" "@type" "Organization" "name" $orgName "url" $orgUrl) -}}
{{- if $orgLogo }}
  {{- $orgScratch.Set "data" (merge ($orgScratch.Get "data") (dict "logo" (dict "@type" "ImageObject" "url" (absURL $orgLogo)))) -}}
{{- end }}
{{- if $sameAs }}
  {{- $orgScratch.Set "data" (merge ($orgScratch.Get "data") (dict "sameAs" $sameAs)) -}}
{{- end }}
<script type="application/ld+json">{{ jsonify ($orgScratch.Get "data") | safeJS }}</script>

{{- $languageCode := default "en-US" (or $page.Language.LanguageCode $site.LanguageCode) -}}
{{- $baseUrl := $site.BaseURL | default $page.Permalink -}}
{{- $websiteScratch := newScratch -}}
{{- $websiteScratch.Set "data" (dict
    "@context" "https://schema.org"
    "@type" "WebSite"
    "name" $site.Title
    "url" $baseUrl
    "inLanguage" $languageCode
  ) -}}
{{- with $seo.description }}
  {{- $websiteScratch.Set "data" (merge ($websiteScratch.Get "data") (dict "description" .)) -}}
{{- end }}
{{- if $sameAs }}
  {{- $websiteScratch.Set "data" (merge ($websiteScratch.Get "data") (dict "sameAs" $sameAs)) -}}
{{- end }}
{{- if $siteParams.search.enable }}
  {{- $baseTrimmed := replaceRE "/+$" "" $baseUrl -}}
  {{- $searchTarget := printf "%s/search/?q={search_term_string}" $baseTrimmed -}}
  {{- $websiteScratch.Set "data" (merge ($websiteScratch.Get "data") (dict "potentialAction" (dict "@type" "SearchAction" "target" $searchTarget "query-input" "required name=search_term_string"))) -}}
{{- end }}
<script type="application/ld+json">{{ jsonify ($websiteScratch.Get "data") | safeJS }}</script>

{{- $pageType := cond (eq ($seo.type) "article") "Article" "WebPage" -}}
{{- $pageScratch := newScratch -}}
{{- $pageScratch.Set "data" (dict
    "@context" "https://schema.org"
    "@type" $pageType
    "name" ($seo.title)
    "headline" ($seo.title)
    "description" ($seo.description)
    "url" ($seo.canonical | default $page.Permalink)
    "inLanguage" $languageCode
    "mainEntityOfPage" ($seo.canonical | default $page.Permalink)
    "isPartOf" (dict "@type" "WebSite" "name" $site.Title "url" $baseUrl)
  ) -}}
{{- with $seo.image }}
  {{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "image" (slice .))) -}}
{{- end }}
{{- with $seo.author }}
  {{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "author" (dict "@type" "Person" "name" .))) -}}
{{- else }}
  {{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "author" (dict "@type" "Organization" "name" $orgName "url" $orgUrl))) -}}
{{- end }}
{{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "publisher" (dict "@type" "Organization" "name" $orgName "url" $orgUrl))) -}}
{{- with $seo.keywords }}
  {{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "keywords" .)) -}}
{{- end }}
{{- if eq $pageType "Article" }}
  {{- with $seo.published }}
    {{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "datePublished" (.Format "2006-01-02T15:04:05Z07:00"))) -}}
  {{- end }}
  {{- with $seo.modified }}
    {{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "dateModified" (.Format "2006-01-02T15:04:05Z07:00"))) -}}
  {{- else }}
    {{- with $page.Lastmod }}
      {{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "dateModified" (.Format "2006-01-02T15:04:05Z07:00"))) -}}
    {{- end }}
  {{- end }}
  {{- with $page.Section }}
    {{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "articleSection" .)) -}}
  {{- end }}
  {{- with $page.Params.tags }}
    {{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "about" .)) -}}
  {{- end }}
  {{- if gt $page.WordCount 0 }}
    {{- $pageScratch.Set "data" (merge ($pageScratch.Get "data") (dict "wordCount" $page.WordCount)) -}}
  {{- end }}
{{- end }}
<script type="application/ld+json">{{ jsonify ($pageScratch.Get "data") | safeJS }}</script>

{{- $crumbScratch := newScratch -}}
{{- $crumbScratch.Set "nodes" (slice) -}}
{{- range $page.Ancestors.Reverse }}
  {{- $crumbScratch.Add "nodes" (slice .) -}}
{{- end }}
{{- $crumbScratch.Add "nodes" (slice $page) -}}
{{- $crumbNodes := $crumbScratch.Get "nodes" -}}
{{- if gt (len $crumbNodes) 1 }}
  {{- $itemsScratch := newScratch -}}
  {{- $itemsScratch.Set "items" (slice) -}}
  {{- range $index, $crumb := $crumbNodes }}
    {{- $name := default $crumb.LinkTitle $crumb.Title -}}
    {{- $item := dict "@type" "ListItem" "position" (add $index 1) "name" $name "item" $crumb.Permalink -}}
    {{- $itemsScratch.Add "items" (slice $item) -}}
  {{- end }}
  {{- $items := $itemsScratch.Get "items" -}}
  {{- if gt (len $items) 1 }}
    <script type="application/ld+json">{{ jsonify (dict "@context" "https://schema.org" "@type" "BreadcrumbList" "itemListElement" $items) | safeJS }}</script>
  {{- end }}
{{- end }}

{{/* FAQ Schema - Auto-generated for country pages with flag parameter */}}
{{- $lang := $page.Lang | default $site.Language.Lang -}}
{{- if $page.Params.flag }}
  {{- $faqScratch := newScratch -}}
  {{- $faqScratch.Set "questions" (slice) -}}
  {{- $countryName := $page.Title -}}
  {{- $questionText := "" -}}
  {{- $answerText := "" -}}
  {{- if $seo.description -}}
    {{- $answerText = $seo.description -}}
  {{- else if $page.Summary -}}
    {{- $answerText = ($page.Summary | plainify) -}}
  {{- else if $page.Plain -}}
    {{- $answerText = ($page.Plain | plainify) -}}
  {{- end -}}
  {{- $answerText = ($answerText | strings.TrimSpace) -}}
  {{- if eq $lang "ja" }}
    {{- $questionText = printf "GeoGuessrで%sを見分けるには？" $countryName -}}
  {{- else if eq $lang "en" }}
    {{- $questionText = printf "How to identify %s in GeoGuessr?" $countryName -}}
  {{- else if eq $lang "id" }}
    {{- $questionText = printf "Bagaimana cara mengenali %s di GeoGuessr?" $countryName -}}
  {{- else if eq $lang "es" }}
    {{- $questionText = printf "¿Cómo identificar %s en GeoGuessr?" $countryName -}}
  {{- else if eq $lang "pt" }}
    {{- $questionText = printf "Como identificar %s no GeoGuessr?" $countryName -}}
  {{- else }}
    {{- $questionText = printf "How to identify %s in GeoGuessr?" $countryName -}}
  {{- end }}
  {{- if $answerText -}}
    {{- $qaItem := dict "@type" "Question" "name" $questionText "acceptedAnswer" (dict "@type" "Answer" "text" $answerText) -}}
    {{- $faqScratch.Add "questions" (slice $qaItem) -}}
    {{- $faqData := dict "@context" "https://schema.org" "@type" "FAQPage" "mainEntity" ($faqScratch.Get "questions") -}}
    <script type="application/ld+json">{{ jsonify $faqData | safeJS }}</script>
  {{- end }}
{{- end }}

{{/* FAQ Schema - Custom FAQ from frontmatter */}}
{{- with $page.Params.faq }}
  {{- $customFaqScratch := newScratch -}}
  {{- $customFaqScratch.Set "questions" (slice) -}}
  {{- range . }}
    {{- $questionText := (.question | default "" | plainify | strings.TrimSpace) -}}
    {{- $answerText := (.answer | default "" | plainify | strings.TrimSpace) -}}
    {{- if and $questionText $answerText -}}
      {{- $qaItem := dict "@type" "Question" "name" $questionText "acceptedAnswer" (dict "@type" "Answer" "text" $answerText) -}}
      {{- $customFaqScratch.Add "questions" (slice $qaItem) -}}
    {{- end -}}
  {{- end }}
  {{- if gt (len ($customFaqScratch.Get "questions")) 0 -}}
    {{- $customFaqData := dict "@context" "https://schema.org" "@type" "FAQPage" "mainEntity" ($customFaqScratch.Get "questions") -}}
    <script type="application/ld+json">{{ jsonify $customFaqData | safeJS }}</script>
  {{- end }}
{{- end }}

{{/* HowTo Schema - Auto-generated for country pages with flag parameter */}}
{{- if $page.Params.flag }}
  {{- $howtoScratch := newScratch -}}
  {{- $howtoScratch.Set "steps" (slice) -}}
  {{- $countryName := $page.Title -}}
  {{- $howtoName := "" -}}
  {{- if eq $lang "ja" }}
    {{- $howtoName = printf "GeoGuessrで%sを見分ける方法" $countryName -}}
  {{- else if eq $lang "en" }}
    {{- $howtoName = printf "How to identify %s in GeoGuessr" $countryName -}}
  {{- else if eq $lang "id" }}
    {{- $howtoName = printf "Cara mengenali %s di GeoGuessr" $countryName -}}
  {{- else if eq $lang "es" }}
    {{- $howtoName = printf "Cómo identificar %s en GeoGuessr" $countryName -}}
  {{- else if eq $lang "pt" }}
    {{- $howtoName = printf "Como identificar %s no GeoGuessr" $countryName -}}
  {{- else }}
    {{- $howtoName = printf "How to identify %s in GeoGuessr" $countryName -}}
  {{- end }}
  {{- $stepIndex := 1 -}}
  {{- $stepText1 := "" -}}
  {{- $stepText2 := "" -}}
  {{- $stepText3 := "" -}}
  {{- if eq $lang "ja" }}
    {{- $stepText1 = "ストリートビューの風景を観察する" -}}
    {{- $stepText2 = "看板、標識、言語などの特徴を確認する" -}}
    {{- $stepText3 = "地形や植生から地域を絞り込む" -}}
  {{- else }}
    {{- $stepText1 = "Observe the Street View landscape" -}}
    {{- $stepText2 = "Check signs, road markers, and language" -}}
    {{- $stepText3 = "Narrow down the region from terrain and vegetation" -}}
  {{- end }}
  {{- $step1 := dict "@type" "HowToStep" "position" 1 "name" $stepText1 "text" $stepText1 -}}
  {{- $step2 := dict "@type" "HowToStep" "position" 2 "name" $stepText2 "text" $stepText2 -}}
  {{- $step3 := dict "@type" "HowToStep" "position" 3 "name" $stepText3 "text" $stepText3 -}}
  {{- $howtoScratch.Add "steps" (slice $step1 $step2 $step3) -}}
  {{- $howtoData := dict "@context" "https://schema.org" "@type" "HowTo" "name" $howtoName "description" $seo.description "step" ($howtoScratch.Get "steps") -}}
  {{- with $seo.image }}
    {{- $howtoData = merge $howtoData (dict "image" .) -}}
  {{- end }}
  <script type="application/ld+json">{{ jsonify $howtoData | safeJS }}</script>
{{- end }}
